<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orchestrator Task Viewer</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .task-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .task-goal {
            font-size: 18px;
            font-weight: 600;
            color: #2563eb;
            margin-bottom: 10px;
        }
        .task-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        .status-running { background: #fef3c7; color: #92400e; }
        .status-done { background: #d1fae5; color: #065f46; }
        .status-error { background: #fee2e2; color: #991b1b; }
        .screenshots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .screenshot {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }
        .screenshot img {
            width: 100%;
            height: auto;
            display: block;
        }
        .screenshot-title {
            padding: 10px;
            font-weight: 500;
            color: #374151;
            border-top: 1px solid #e5e7eb;
        }
        .refresh-btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .refresh-btn:hover { background: #1d4ed8; }
        .loading { color: #6b7280; font-style: italic; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ¤– Orchestrator Task Viewer</h1>
        <button class="refresh-btn" onclick="loadTasks()">Refresh Tasks</button>
        <span id="status" class="loading">Loading...</span>
    </div>
    
    <div id="tasks"></div>

    <script>
        const API_BASE = (location.origin && location.origin.startsWith('http')) ? location.origin : 'http://127.0.0.1:4100';
        let tasks = {};

        async function loadTasks() {
            const status = document.getElementById('status');
            status.textContent = 'Loading tasks...';
            status.className = 'loading';

            try {
                // Get health check to see if server is running
                const health = await fetch(`${API_BASE}/health`).then(r => r.json());
                
                // Get task list from API
                const taskList = await fetch(`${API_BASE}/tasks`).then(r => r.json());
                
                const tasksContainer = document.getElementById('tasks');
                tasksContainer.innerHTML = '';

                if (taskList.length === 0) {
                    tasksContainer.innerHTML = '<div class="task-card">No tasks found. Create a task using the post-task.ps1 script.</div>';
                    status.textContent = 'No tasks';
                    return;
                }

                // Show last 5 tasks or filter by URL param
                const urlParams = new URLSearchParams(window.location.search);
                const taskParam = urlParams.get('task');
                
                const tasksToShow = taskParam 
                    ? taskList.filter(t => t.id === taskParam)
                    : taskList.slice(0, 5);

                for (const taskInfo of tasksToShow) {
                    await loadTask(taskInfo.id);
                }

                status.textContent = taskParam 
                    ? `Loaded task ${taskParam.split('-')[0]}...`
                    : `Loaded ${tasksToShow.length} of ${taskList.length} task(s)`;
                status.className = '';
            } catch (error) {
                status.textContent = `Error: ${error.message}`;
                status.className = 'status-error';
            }
        }

        async function loadTask(taskId) {
            try {
                const task = await fetch(`${API_BASE}/tasks/${taskId}`).then(r => r.json());
                const files = await fetch(`${API_BASE}/tasks/${taskId}/files`).then(r => r.json());

                const taskCard = document.createElement('div');
                taskCard.className = 'task-card';

                taskCard.innerHTML = `
                    <div class="task-goal">${task.goal}</div>
                    <div>
                        <span class="task-status status-${task.status}">${task.status}</span>
                        <span style="margin-left: 10px; color: #6b7280; font-size: 14px;">
                            ID: ${task.id.split('-')[0]}... | Steps: ${task.steps.length}
                        </span>
                    </div>
                    ${files.length > 0 ? `
                        <div class="screenshots">
                            ${files.map(file => `
                                <div class="screenshot">
                                    <img src="${API_BASE}${file.url}" alt="Step ${file.step}" loading="lazy" />
                                    <div class="screenshot-title">Step ${file.step}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p style="margin-top: 15px; color: #6b7280;">No screenshots available</p>'}
                `;

                document.getElementById('tasks').appendChild(taskCard);
            } catch (error) {
                console.error('Failed to load task:', taskId, error);
            }
        }

        // No more localStorage needed - we get tasks from the API!

        // Load tasks on page load
        loadTasks();
        
        // Auto-refresh every 10 seconds
        setInterval(loadTasks, 10000);
    </script>
</body>
</html>
